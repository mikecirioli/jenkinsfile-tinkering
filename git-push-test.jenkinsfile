properties([
    disableConcurrentBuilds(),
    parameters([
            booleanParam(
                    name: 'archive',
                    description: 'Archive the report PDF back to a GH repo'
            ),
            string(
                    name: 'publishRepoOwner',
                    defaultValue: 'mikecirioli',
                    description: 'When publishing the PDF report, push it to git@github.com:${archiveRepoOwner}/cbci-performance-setup.git'
            ),
            string(
                    name: 'publishRepoBranch',
                    defaultValue: 'master',
                    description: 'When publishing the PDF report, push it to this branch in the repo'
            )
    ]),
    buildDiscarder(
            logRotator(daysToKeepStr: '30')
    )
])

node {
    stage('Publish Report') {
        dir("archive-reports") {
            sshagent(['github-ssh']) {
                withEnv(["REPORT_REPO_OWNER=" + params.publishRepoOwner,
                        "REPORT_REPO_BRANCH=" + params.publishRepoBranch]) {
                    //sh "../scripts/archive_reports.sh -o ${REPORT_REPO_OWNER} -b ${REPORT_REPO_BRANCH}"
                    sh '''
                        pwd
                        echo "REPORT_REPO_OWNER=${REPORT_REPO_OWNER}"
                        echo "REPORT_REPO_BRANCH=${REPORT_REPO_BRANCH}"
                        git clone git@github.com:$GIT_REPO_OWNER/jenkinsfile-tinkering.git upload-reports
                        cd upload-reports
                        git checkout $GIT_REPO_BRANCH
                    '''
                }
            }
        }
    }
}
